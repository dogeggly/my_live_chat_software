### pgsql

- 使用联合索引保证群组成员和好友不会被重复添加
- 使用枚举类型
- 使用触发器和触发器函数统一管理 update_time
- 使用 ip 类型
- 使用部分索引和逻辑删除

### gin 索引

- 利用了三元组模型扩展，在nickname字段上加gin索引，会在like查询和%查询中生效
- 传统的like查询加b-tree索引只能在前缀模糊匹配时生效
- gin索引会对nickname分词，比如apple分词成' a',' ap','app','ppl','ple','le '，前面两个空格后面一个空格（md打不出来多空格）
- like先用gin索引查询，再进行二次匹配，看是否包含完整的apple
- 同时用%查询出不包含完整apple但包含分散的apple或部分apple的数据
- 最后进行二维排序，含完整apple排前面，不含的排后面，这两部分分别进行子排序，相似度高的排前面，低的排后面
- 相似度similarity()函数大致由包含的token数量除上所有token数量得来
- 如果业务中经常用到等值查询，另使用b-tree会更快，并指定C字符序（即用纯二进制匹配，不考虑大小写等语言特性）
- 更进一步可以等值查询走redis的hash，前缀匹配走redis的zset（将分数设为一样的话，zset会按照字典序排，且内部有跳表优化查询），模糊匹配走数据库gin
- 限定limit 30，可以不用考虑深度分页和并发写入时offset偏移的问题